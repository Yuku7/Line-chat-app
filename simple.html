<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ã‚¯ã‚¤ã‚ºãƒãƒ£ãƒƒãƒˆã‚²ãƒ¼ãƒ </title>
<style>
    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
  body {
    font-family: Arial, sans-serif;
    /* èƒŒæ™¯è‰² */
    background: #e6f7ff;
     /* æ–‡å­—è‰² */
    color: #333;
    margin: 0;
    padding: 0;
  }
   /* ãƒãƒ£ãƒƒãƒˆã®è¡¨ç¤ºéƒ¨åˆ† */
  #output {
    overflow: auto;
    height: 300px;
    background: #f0f8ff;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
  }
  /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .chat-bubble {
    margin: 10px 0;
    padding: 10px;
    border-radius: 15px;
    display: inline-block;
    max-width: 80%;
  }
   /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .my-message {
     /* ãƒ”ãƒ³ã‚¯è‰² */
    background: #ffdab9;
    color: #000;
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³å´ã«å¯„ã›ã‚‹ */
    align-self: flex-end;
  }
   /* ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .other-message {
    /* æ°´è‰² */
    background: #add8e6;
    color: #000;
  }
  /* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #scoreboard {
    margin-top: 10px;
    padding: 10px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
   /* è¦‹å‡ºã—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
   /* ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ */
  h1 {
    color: #003366;
  }
</style>
</head>
<body>

<div>
    <h1>ã‚¯ã‚¤ã‚ºãƒãƒ£ãƒƒãƒˆã‚²ãƒ¼ãƒ  ğŸ®</h1>
    <p>3å›é–“é•ãˆã‚‹ã¨ãƒ©ã‚¤ãƒ³ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼</p>
     <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã™ã‚‹æ¬„ -->
    <div> åå‰ï¼š<input type="text" id="uname"> </div>
     <!-- ç­”ãˆã‚’å…¥åŠ›ã™ã‚‹æ¬„ -->
    <div>
        <textarea id="text" cols="30" rows="3" placeholder="ç­”ãˆã‚’å…¥åŠ›ã—ã‚ˆã†ï¼"></textarea>
        <button id="send">é€ä¿¡</button>
    </div>
    <!-- ãƒãƒ£ãƒƒãƒˆã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="output"></div>
    <!-- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
    <div id="scoreboard">
        <h2>ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰</h2>
        <ul id="scores"></ul>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="module">
     // Firebase ã®åˆæœŸè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, push, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    // Firebaseã®è¨­å®šæƒ…å ±
    const firebaseConfig = {
       
        authDomain: "line-chat-app-99571.firebaseapp.com",
        projectId: "line-chat-app-99571",
        storageBucket: "line-chat-app-99571.firebasestorage.app",
        messagingSenderId: "25131298204",
        appId: "1:25131298204:web:85b38c9d89536e4863ec59"
    };
     // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, "quiz-chat");
    const scoresRef = ref(db, "scores");
    
    // ã‚¯ã‚¤ã‚ºã®å•é¡Œã¨ç­”ãˆ
    const quizQuestions = [
        { question: "æ—¥æœ¬ã§ä¸€ç•ªé«˜ã„å±±ã¯ï¼Ÿ", answer: ["å¯Œå£«å±±"], hint: "æ¨™é«˜3776mã€‚" },
        { question: "é­”æ³•ç•Œã§æœ€ã‚‚æœ‰åãªå°‘å¹´ã®åå‰ã¯ï¼Ÿ", answer: ["ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼", "ãƒãƒªãƒ¼ãƒãƒƒã‚¿ãƒ¼"], hint: "ãƒ›ã‚°ãƒ¯ãƒ¼ãƒ„ã®ç”Ÿå¾’ã§ã™ã€‚" },
        { question: "ã‚»ã‚«ã‚¤ã‚’å¤‰ãˆã‚‹GEEKã®ãŸã‚ã®èµ·æ¥­å®¶ãƒ»ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚¹ã‚¯ãƒ¼ãƒ«ã¯ï¼Ÿ", answer: ["Gâ€™s ACADEMY", "ã‚¸ãƒ¼ã‚ºã‚¢ã‚«ãƒ‡ãƒŸãƒ¼"], hint: "ã€ŒGâ€™s ã€ã¨ã€Œã‚¸ãƒ¼ã‚ºã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ã€ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‚" },
        { question: "é’ã„ä½“ã‚’æŒã¤ãƒã‚³å‹ãƒ­ãƒœãƒƒãƒˆã®åå‰ã¯ï¼Ÿ", answer: ["ãƒ‰ãƒ©ãˆã‚‚ã‚“"], hint: "å››æ¬¡å…ƒãƒã‚±ãƒƒãƒˆãŒç‰¹å¾´ã§ã™ã€‚" },
        { question: "æµ·è³Šç‹ã‚’ç›®æŒ‡ã™éº¦ã‚ã‚‰å¸½å­ã®ä¸»äººå…¬ã¯ï¼Ÿ", answer: ["ãƒ«ãƒ•ã‚£"], hint: "ã‚´ãƒ ã‚´ãƒ ã®å®Ÿã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚" }
    ];

    // ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    let currentQuestionIndex = 0;
     // ç¾åœ¨ã®è©¦è¡Œå›æ•°
    let currentAttempts = 0;
    // æœ€å¤§è©¦è¡Œå›æ•°ï¼ˆé–“é•ãˆãŸå›æ•°ï¼‰
    const maxAttempts = 3;
    // æ­£è§£ã®å¾—ç‚¹
    const pointsPerCorrectAnswer = 10;
    // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    let scores = {};
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç­”ãˆã‚’æ­£è¦åŒ–ï¼ˆç©ºç™½é™¤å»ã¨å°æ–‡å­—åŒ–ï¼‰
    const normalizeAnswer = (text) => text.replace(/\s+/g, "").toLowerCase();
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç­”ãˆãŒæ­£ã—ã„ã‹ç¢ºèª
    const isAnswerCorrect = (userAnswer, correctAnswers) => {
        const normalizedUser = normalizeAnswer(userAnswer);
        return correctAnswers.some(answer => normalizeAnswer(answer) === normalizedUser);
    };
    
    // ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã‚’å–å¾—
    const getCurrentQuiz = () => quizQuestions[currentQuestionIndex];
    
    // ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã®å•é¡Œã‚’ãƒãƒ£ãƒƒãƒˆã«æŠ•ç¨¿
    const postQuiz = () => {
        const quiz = getCurrentQuiz();
        const message = `ã€å•é¡Œã€‘\n${quiz.question}`;
        const quizMessage = { uname: "ç®¡ç†è€…", text: message, timestamp: new Date().toLocaleString() };
        // ã‚¯ã‚¤ã‚ºãŒçµ‚äº†ã—ãŸå ´åˆ
        set(push(chatRef), quizMessage);
    };
    
     // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
    const updateScoreboard = () => {
        const scoresList = Object.entries(scores)
            .sort((a, b) => b[1] - a[1])
            .map(([uname, score]) => `<li>${uname}: ${score}ãƒã‚¤ãƒ³ãƒˆ</li>`)
            .join("");
        $("#scores").html(scoresList);
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
    $("#send").on("click", function() {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        const uname = $("#uname").val();
        // å…¥åŠ›ã•ã‚ŒãŸç­”ãˆ
        const text = $("#text").val();
        if (!uname || !text) {
            alert("åå‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
            return;
        }

        const currentQuiz = getCurrentQuiz();

        // ãƒ’ãƒ³ãƒˆç„¡ã—ã§æ­£è§£ã—ãŸå ´åˆã®ã¿ãƒã‚¤ãƒ³ãƒˆåŠ ç®—
        if (isAnswerCorrect(text, currentQuiz.answer)) {
            if (currentAttempts === 0) {  // ãƒ’ãƒ³ãƒˆã‚’ä½¿ã‚ãšæ­£è§£ã—ãŸå ´åˆ
                if (!scores[uname]) scores[uname] = 0;
                scores[uname] += pointsPerCorrectAnswer;
                update(scoresRef, { [uname]: scores[uname] });
            }
            set(push(chatRef), { uname, text: "âœ… æ­£è§£ï¼ğŸ‰", timestamp: new Date().toLocaleString() });
            currentQuestionIndex++;
            currentAttempts = 0;
            if (currentQuestionIndex < quizQuestions.length) {
                postQuiz();
            } else {
                set(push(chatRef), { uname: "ç®¡ç†è€…", text: "ã‚¯ã‚¤ã‚ºãŒçµ‚äº†ã—ã¾ã—ãŸï¼", timestamp: new Date().toLocaleString() });
            }
        } else {
            currentAttempts++;
            // 3å›é–“é•ãˆãŸå ´åˆ
            if (currentAttempts >= maxAttempts) {
                set(push(chatRef), { uname: "ç®¡ç†è€…", text: `âŒ 3å›é–“é•ãˆã¾ã—ãŸï¼\næ­£è§£ã¯ã€Œ${currentQuiz.answer[0]}ã€ã§ã—ãŸï¼`, timestamp: new Date().toLocaleString() });
                // æ¬¡ã®å•é¡Œã¸
                currentQuestionIndex++;
                // è©¦è¡Œå›æ•°ãƒªã‚»ãƒƒãƒˆ
                currentAttempts = 0;
                if (currentQuestionIndex < quizQuestions.length) {
                    // æ¬¡ã®å•é¡Œã‚’è¡¨ç¤º
                    postQuiz();
                }
            } else {
                // ä¸æ­£è§£ã®å ´åˆ
                set(push(chatRef), { uname, text: `âŒ ä¸æ­£è§£ï¼ãƒ’ãƒ³ãƒˆ: ${currentQuiz.hint}`, timestamp: new Date().toLocaleString() });
            }
        }
        // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
        $("#text").val("");
    });
    
    // ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤º
    onValue(chatRef, (snapshot) => {
        const data = snapshot.val();
        // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
        $("#output").empty();
        for (const key in data) {
            const msg = data[key];
            const h = `  
                <div class="chat-bubble ${msg.uname === $("#uname").val() ? "my-message" : "other-message"}">
                    <strong>${msg.uname}</strong>: ${msg.text} <br> <small>${msg.timestamp}</small>
                </div>`;
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            $("#output").append(h);
        }
    });

    // ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°
    onValue(scoresRef, (snapshot) => {
        scores = snapshot.val() || {};
        // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
        updateScoreboard();
    });

     // åˆå›ã®ã‚¯ã‚¤ã‚ºã‚’æŠ•ç¨¿
    postQuiz();
</script>
</body>
</html>
